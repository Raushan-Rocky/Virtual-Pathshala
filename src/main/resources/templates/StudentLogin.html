<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Pathshala - Student Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/StudentLogin.css}">
</head>
<body>
<!-- Navbar -->
<header class="navbar">
    <div class="logo">
        <img th:src="@{/image/logo5.png}" href="#home" alt="Logo">
    </div>

    <!-- Navigation Links -->
    <nav id="nav-links">
        <a href="#home">Home</a>
        <a href="#courses">Courses</a>
        <a href="#">About</a>
        <a href="#contact">Contact</a>
    </nav>

    <!-- Dynamic User Menu -->
    <div class="nav-buttons" id="nav-buttons">
        <!-- Guest buttons (when not logged in) -->
        <div id="guest-buttons">
            <a th:href="@{/login}" class="btn btn-primary">Login</a>
            <a th:href="@{/signup}" class="btn btn-primary">Sign Up</a>
        </div>

        <!-- User menu (when logged in) -->
        <div id="user-menu" class="user-menu">
            <button id="user-btn">
                <img th:src="@{/image/profile.png}" alt="User" class="user-logo" onerror="this.src='https://via.placeholder.com/35'">
                <span class="welcome-text" id="welcome-text">Welcome</span>
            </button>
            <div class="user-popup" id="user-popup">
                <a th:href="@{/student-dashboard}">Dashboard</a>
                <hr>
                <button onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <!-- Hamburger Icon -->
    <div class="hamburger" onclick="toggleMenu()">‚ò∞</div>
</header>

<!-- Background Video -->
<video autoplay muted loop playsinline class="bg-video">
    <source th:src="@{/video/classvideo.mp4}" type="video/mp4">
    Your browser does not support the video tag.
</video>

<div class="global-blur-overlay"></div>

<!-- Hero Section -->
<section class="hero" id="home">
    <div class="video-overlay"></div>
    <div class="hero-content">
        <div class="hero-text">
            <h2>Learn Smarter with <span>Expert Mentors</span> from Kerala</h2>
            <p>Unlock your true potential with guided learning, interactive sessions, and personalized study plans designed to help you succeed anywhere, anytime.</p>
            <a href="#courses" class="btn btn-primary">Start Learning</a>
        </div>
        <img th:src="@{/image/groupPic.png}" alt="Book Reading" class="hero-img">
    </div>
</section>

<!-- Features Section -->
<section class="features" id="courses">
    <h3>üöÄ Select Your Course</h3>
    <p class="sub-text">Learn with the best teachers of Kerala. Join live classes and get certified.</p>

    <div class="feature-cards" id="dynamic-courses-container">
        <!-- Courses will be loaded dynamically from backend -->
        <div class="loading-courses">
            <p>Loading courses...</p>
        </div>
    </div>
</section>

<!-- Footer -->
<footer>
    <div class="footer-content">
        <div class="footer-section footer-about">
            <h3>About Virtual Pathshala</h3>
            <p>Virtual Pathshala is an innovative online learning platform connecting students with expert mentors from Kerala. We provide quality education through interactive live classes and personalized learning paths.</p>
        </div>

        <div class="footer-section footer-social" id="contact">
            <h3>Follow Us</h3>
            <div class="social-icons">
                <a href="https://facebook.com" class="social-icon facebook" target="_blank" title="Facebook">
                    <i class="fab fa-facebook-f"></i>
                </a>
                <a href="https://www.instagram.com/rocky_raushan/" class="social-icon instagram" target="_blank" title="Instagram">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="https://twitter.com" class="social-icon twitter" target="_blank" title="Twitter">
                    <i class="fab fa-twitter"></i>
                </a>
                <a href="https://mail.google.com/mail/u/0/#inbox" class="social-icon gmail" title="Gmail">
                    <i class="fas fa-envelope"></i>
                </a>
                <a href="https://whatsapp.com" class="social-icon whatsapp" title="WhatsApp">
                    <i class="fab fa-whatsapp"></i>
                </a>
                <a href="https://github.com/Raushan-Rocky" class="social-icon github" target="_blank" title="GitHub">
                    <i class="fab fa-github"></i>
                </a>
            </div>
        </div>

        <div class="footer-section footer-contact">
            <h3>Contact Us</h3>
            <p><i class="fas fa-map-marker-alt"></i> Kerala, India</p>
            <p><i class="fas fa-envelope"></i> info@virtualpathshala.com</p>
            <p><i class="fas fa-phone"></i> +91 98765 43210</p>
        </div>
    </div>

    <div class="footer-bottom">
        <p>&copy; <span id="year"></span> Virtual Pathshala. All rights reserved.</p>
        <p class="team-credits">Designed and Developed by Team Virtual Pathshala</p>
    </div>
</footer>

<script th:src="@{/js/auth.js}"></script>
<script>
    // Auto update year in footer
    document.getElementById("year").textContent = new Date().getFullYear();

    // Toggle mobile menu
    function toggleMenu() {
        document.getElementById("nav-links").classList.toggle("show");
        document.querySelector(".nav-buttons").classList.toggle("show");
    }

    // User menu functionality
    document.getElementById('user-btn')?.addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('user-popup').classList.toggle('show');
    });

    // Close user menu when clicking outside
    document.addEventListener('click', function() {
        const popup = document.getElementById('user-popup');
        if (popup) popup.classList.remove('show');
    });

    // ‚úÖ IMPROVED LOGIN STATUS CHECK
    function checkLoginStatus() {
        const userMenu = document.getElementById('user-menu');
        const guestButtons = document.getElementById('guest-buttons');
        const welcomeText = document.getElementById('welcome-text');

        // Check if user is logged in
        const userData = localStorage.getItem('user');

        if (userData) {
            try {
                const user = JSON.parse(userData);

                // ‚úÖ SHOW USER MENU, HIDE GUEST BUTTONS
                if (userMenu) userMenu.style.display = 'block';
                if (guestButtons) guestButtons.style.display = 'none';
                if (welcomeText) {
                    welcomeText.textContent = `Welcome, ${user.name || user.email}`;
                }

                console.log('‚úÖ User is logged in:', user.name || user.email);

            } catch (error) {
                console.error('Error parsing user data:', error);
                showGuestMenu();
            }
        } else {
            showGuestMenu();
        }
    }

    // Show guest menu (when not logged in)
    function showGuestMenu() {
        const userMenu = document.getElementById('user-menu');
        const guestButtons = document.getElementById('guest-buttons');

        if (userMenu) userMenu.style.display = 'none';
        if (guestButtons) guestButtons.style.display = 'block';

        console.log('‚ùå User is not logged in');
    }

    // Logout function
    function logout() {
        // Clear localStorage
        localStorage.removeItem('user');
        localStorage.removeItem('authToken');

        console.log('üö™ User logged out');

        // Redirect to home page
        window.location.href = '/';
    }

    // ‚úÖ NEW: Check enrollment status for courses
    async function checkEnrollmentStatus(courses) {
        try {
            const userData = localStorage.getItem('user');
            if (!userData) return courses;

            const user = JSON.parse(userData);
            const userId = user.id;

            console.log("üîç Checking enrollment status for user:", userId);

            const response = await fetch(`/api/enrollments/user/${userId}`);

            if (response.ok) {
                const result = await response.json();

                if (result.success && result.data) {
                    const userEnrollments = result.data;
                    console.log("‚úÖ User enrollments found:", userEnrollments.length);

                    // Update courses with enrollment status
                    const updatedCourses = courses.map(course => {
                        const isEnrolled = userEnrollments.some(enrollment =>
                            enrollment.course && enrollment.course.id === course.id
                        );

                        return {
                            ...course,
                            isEnrolled: isEnrolled
                        };
                    });

                    return updatedCourses;
                }
            }

            console.log("‚ÑπÔ∏è No enrollments found or error checking status");
            return courses;
        } catch (error) {
            console.error('‚ùå Error checking enrollment status:', error);
            return courses;
        }
    }

    // ‚úÖ UPDATED: Load all courses from backend with enrollment status
    async function loadAllCoursesFromBackend() {
        try {
            console.log("üìö Loading all courses from backend...");

            const response = await fetch('/api/courses/all');

            if (response.ok) {
                const result = await response.json();

                if (result.success) {
                    let courses = result.data;
                    console.log("‚úÖ Courses loaded from backend:", courses);

                    // Check enrollment status for current user
                    courses = await checkEnrollmentStatus(courses);

                    // Update the courses section with dynamic courses
                    updateCourseCards(courses);
                } else {
                    console.error('‚ùå Failed to load courses:', result.message);
                    showDefaultCourses();
                }
            } else {
                console.error('‚ùå HTTP error loading courses');
                showDefaultCourses();
            }
        } catch (error) {
            console.error('‚ùå Error loading courses:', error);
            showDefaultCourses();
        }
    }

    // ‚úÖ UPDATED: Update course cards with enrollment status
    function updateCourseCards(courses) {
        const featureCards = document.getElementById('dynamic-courses-container');

        if (!featureCards) {
            console.error("Courses container not found");
            return;
        }

        if (!courses || courses.length === 0) {
            featureCards.innerHTML = `
                <div class="no-courses">
                    <p>No courses available at the moment. Please check back later.</p>
                </div>
            `;
            return;
        }

        // Clear loading message and add dynamic courses
        featureCards.innerHTML = '';

        courses.forEach(course => {
            const courseCard = createCourseCard(course);
            featureCards.appendChild(courseCard);
        });

        console.log(`‚úÖ Updated ${courses.length} courses dynamically`);
    }

    // ‚úÖ UPDATED: Create course card HTML with enrollment status
    function createCourseCard(course) {
        const card = document.createElement('div');
        card.className = 'card';

        // Get teacher image based on teacher name
        const teacherImage = getTeacherImage(course.teacherName);

        // Format batch details from schedule
        const batchDetails = course.schedule || 'Flexible Timing';

        // Check if user is already enrolled
        const isEnrolled = course.isEnrolled || false;
        const buttonText = isEnrolled ? 'Enrolled ‚úì' : 'Enroll Now';
        const buttonStyle = isEnrolled ? 'background: green; cursor: not-allowed;' : '';
        const disabled = isEnrolled ? 'disabled' : '';

        card.innerHTML = `
            <img th:src="@{${teacherImage}}" alt="${course.title}" onerror="this.src='/image/default-course.jpg'">
            <h4>${course.title}</h4>
            <p><b>Live Batch:</b> ${batchDetails}</p>
            <p><b>Prof ${course.teacherName || 'Expert Faculty'}</b></p>
            <button class="btn-card" onclick="enrollCourse('${course.title}', '${course.code} - ${course.title}', 'Prof ${course.teacherName}', '${batchDetails}', this)"
                    ${disabled} style="${buttonStyle}">
                ${buttonText}
            </button>
        `;

        return card;
    }

    // ‚úÖ NEW: Get teacher image based on teacher name
    function getTeacherImage(teacherName) {
        const teacherImages = {
            'Divya G': '/image/divyaG.jpg',
            'Deepa Nair': '/image/deepaNair.jpg',
            'Radhika B': '/image/radhikaB.jpg',
            'Riya Rashid': '/image/riya.jpg',
            'Neethu Ganesh': '/image/neethuG.jpg',
            'Anup Suleman': '/image/anup.jpg'
        };

        return teacherImages[teacherName] || '/image/default-teacher.jpg';
    }

    // ‚úÖ NEW: Show default courses if backend fails
    function showDefaultCourses() {
        const featureCards = document.getElementById('dynamic-courses-container');

        if (!featureCards) return;

        featureCards.innerHTML = `
            <div class="card">
                <img th:src="@{/image/divyaG.jpg}" alt="Java Development">
                <h4>15th Nov - Java Development</h4>
                <p><b>Live Batch:</b> Zero to Hero (8:00 AM - 9:00 AM)</p>
                <p><b>Prof Miss Divya G</b></p>
                <button class="btn-card" onclick="enrollCourse('Java Development', '15th Nov - Java Development', 'Prof Miss Divya G', 'Zero to Hero (8:00 AM - 9:00 AM)', this)">Enroll Now</button>
            </div>

            <div class="card">
                <img th:src="@{/image/deepaNair.jpg}" alt="AI Recommendations">
                <h4>15 December - DSA with C</h4>
                <p><b>Live Batch:</b> Zero to Hero (9:15 AM - 10:15 AM)</p>
                <p><b>Prof Miss Deepa Nair</b></p>
                <button class="btn-card" onclick="enrollCourse('DSA with C', '15 December - DSA with C', 'Prof Miss Deepa Nair', 'Zero to Hero (9:15 AM - 10:15 AM)', this)">Enroll Now</button>
            </div>

            <div class="card">
                <img th:src="@{/image/radhikaB.jpg}" alt="Secure Access">
                <h4>15th Nov - Computer Network</h4>
                <p><b>Live Batch:</b> Zero to Hero (8:00 AM - 9:00 AM)</p>
                <p><b>Prof Miss Radhika B</b></p>
                <button class="btn-card" onclick="enrollCourse('Computer Network', '15th Nov - Computer Network', 'Prof Miss Radhika B', 'Zero to Hero (8:00 AM - 9:00 AM)', this)">Enroll Now</button>
            </div>

            <div class="card">
                <img th:src="@{/image/riya.jpg}" alt="Expert Teachers">
                <h4>15 Dec - Android Application Programming</h4>
                <p><b>Live Batch:</b> Zero to Hero (9:15 AM - 10:15 AM)</p>
                <p><b>Prof Miss Riya Rashid</b></p>
                <button class="btn-card" onclick="enrollCourse('Android Application Programming', '15 Dec - Android Application Programming', 'Prof Miss Riya Rashid', 'Zero to Hero (9:15 AM - 10:15 AM)', this)">Enroll Now</button>
            </div>

            <div class="card">
                <img th:src="@{/image/neethuG.jpg}" alt="Certified Courses">
                <h4>15 Dec - Web Technology & Programming</h4>
                <p><b>Live Batch:</b> Zero to Hero (9:15 AM - 10:15 AM)</p>
                <p><b>Prof Miss Neethu Ganesh</b></p>
                <button class="btn-card" onclick="enrollCourse('Web Technology & Programming', '15 Dec - Web Technology & Programming', 'Prof Miss Neethu Ganesh', 'Zero to Hero (9:15 AM - 10:15 AM)', this)">Enroll Now</button>
            </div>

            <div class="card">
                <img th:src="@{/image/anup.jpg}" alt="Community Support">
                <h4>15 Dec - Python Programming</h4>
                <p><b>Live Batch:</b> Zero to Hero (9:15 AM - 10:15 AM)</p>
                <p><b>Prof Miss Anup Suleman</b></p>
                <button class="btn-card" onclick="enrollCourse('Python Programming', '15 Dec - Python Programming', 'Prof Miss Anup Suleman', 'Zero to Hero (9:15 AM - 10:15 AM)', this)">Enroll Now</button>
            </div>
        `;

        console.log("üìö Showing default courses as fallback");
    }

    // ‚úÖ UPDATED: Course enrollment function with actual backend integration
    async function enrollCourse(courseName, courseTitle, professor, batchDetails, button) {
        console.log("üéØ Enrollment clicked for: " + courseName);

        // Get current user
        const userData = localStorage.getItem('user');
        if (!userData) {
            alert('Please login first');
            window.location.href = '/login';
            return;
        }

        try {
            const user = JSON.parse(userData);
            if (!user.id) {
                alert('User data not found. Please login again.');
                return;
            }

            // Show loading
            const originalText = button.textContent;
            button.textContent = 'Enrolling...';
            button.disabled = true;

            // First, get course ID from backend
            const coursesResponse = await fetch('/api/courses/all');
            if (!coursesResponse.ok) {
                throw new Error('Failed to fetch courses');
            }

            const coursesResult = await coursesResponse.json();
            const courses = coursesResult.data || [];

            // Find the course by title
            const course = courses.find(c => c.title === courseName);
            if (!course) {
                throw new Error('Course not found');
            }

            // Create enrollment data for backend
            const enrollmentData = {
                userId: user.id,
                courseId: course.id
            };

            console.log("üìù Enrollment data:", enrollmentData);

            // Call enrollment API
            const response = await fetch('/api/enrollments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(enrollmentData)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                // Update local storage with enrollment data
                updateUserEnrollments(user.id, {
                    courseName: courseName,
                    courseTitle: courseTitle,
                    professor: professor,
                    batchDetails: batchDetails,
                    enrollmentDate: new Date().toISOString(),
                    status: 'Enrolled',
                    courseId: course.id
                });

                alert('‚úÖ Successfully enrolled in ' + courseName + '!');
                button.textContent = 'Enrolled ‚úì';
                button.style.background = 'green';
                button.disabled = true;

                console.log('üéâ Enrollment successful:', result);

                // Reload courses to update enrollment status for all courses
                setTimeout(() => {
                    loadAllCoursesFromBackend();
                }, 1000);

            } else {
                throw new Error(result.error || result.message || 'Enrollment failed');
            }

        } catch (error) {
            console.error('Enrollment error:', error);
            alert('‚ùå Enrollment failed: ' + error.message);
            button.textContent = 'Enroll Now';
            button.disabled = false;
        }
    }

    // Update user enrollments in localStorage
    function updateUserEnrollments(userId, enrollmentData) {
        // Get existing enrollments
        let userEnrollments = JSON.parse(localStorage.getItem('userEnrollments')) || {};

        // Initialize user's enrollment array if it doesn't exist
        if (!userEnrollments[userId]) {
            userEnrollments[userId] = [];
        }

        // Check if user is already enrolled in this course
        const isAlreadyEnrolled = userEnrollments[userId].some(
            enrollment => enrollment.courseName === enrollmentData.courseName
        );

        if (!isAlreadyEnrolled) {
            // Add new enrollment
            userEnrollments[userId].push(enrollmentData);

            // Save back to localStorage
            localStorage.setItem('userEnrollments', JSON.stringify(userEnrollments));

            console.log('‚úÖ Enrollment saved for user:', userId);
        } else {
            console.log('‚ÑπÔ∏è User already enrolled in this course');
        }
    }

    // ‚úÖ BETTER INITIALIZATION
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üéì StudentLogin page loaded');

        // Check login status immediately
        checkLoginStatus();

        // Load courses from backend
        loadAllCoursesFromBackend();

        // Also check when page becomes visible (in case of multiple tabs)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                checkLoginStatus();
            }
        });

        // Optional: Check every 5 seconds for login status changes
        setInterval(checkLoginStatus, 5000);
    });
</script>
</body>
</html>